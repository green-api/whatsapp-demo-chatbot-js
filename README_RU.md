# whatsapp-demo-js-js

- [Documentation in English](README.md).

Пример чатбота написанного на js с использованием API сервиса для Whatsapp [green-api.com](https://green-api.com/).
Чатбот наглядно демонстрирует использование API для отправки текстовых сообщений, файлов, картинок, локаций и контактов.


## Содержание

* [Установка среды для запуска чатбота](#установка-среды-для-запуска-чатбота)
* [Запуск чатбота](#запуск-чатбота)
* [Настройка чатбота](#настройка-чатбота)
* [Использование](#использование)
* [Структура кода](#структура-кода)
* [Управление сообщениями](#управление-сообщениями)


## Установка среды для запуска чатбота

Для запуска чатбота необходимо произвести установку среды js. Если необходимо загрузите и установите последнюю версию Node.js с [официального веб-сайта.](https://nodejs.org/en)

После завершения необходимо проверить была ли среда развернута корректно. Для этого откройте командную строку (например, cmd или bash) и введите запрос:
```
node -v
```

Скачайте и разархивируйте [zip-архив](https://github.com/green-api/whatsapp-demo-chatbot-js) проекта или клонируйте его командой системы контроля версий:

<details>
<summary>Как установить систему контроля версий Git?</summary>

Скачайте и установите систему контроля версий Git, подходящую для используемой операционной системы, с [официального вебсайта](https://git-scm.com/downloads).
</details>

```
git clone https://github.com/green-api/whatsapp-demo-chatbot-js
```

Откройте проект в любой IDE.

Среда для запуска чатбота готова, теперь необходимо произвести настройку и запустить чатбот на вашем аккаунте Whatsapp.

## Запуск чатбота

Для того чтобы настроить чатбот на своем аккаунте Whatsapp, Вам необходимо перейти в [личный кабинет](https://console.green-api.com/) и зарегистрироваться. Для новых пользователей предоставлена [инструкция](https://green-api.com/docs/before-start/) для настройки аккаунта и получения необходимых для работы чатбота параметров, а именно:
```
    idInstance
    apiTokenInstance
```

После получения данных параметров, найдите файл [`bot.js`](bot.js) и введите `idInstance` и `apiTokenInstance` в значения констант.
Инициализация данных необходима для связывания бота с Вашим Whatsapp аккаунтом:

```javascript
    const bot = new WhatsAppBot({
        idInstance: "{{idInstance}}",
        apiTokenInstance: "{{apiTokenInstance}}",
    })
```

Далее можно запускать программу, для этого нажмите пуск в интерфейсе IDE или введите следующий запрос в командной строке:
```
    node bot.js
```
Данный запрос запустит работу чатбота. Процесс начинается с инициализации чатбота, которая включает в себя изменение настроек связанного инстанса.

В библиотеке [whatsapp-chatbot-js](https://github.com/green-api/whatsapp-chatbot-js) прописан механизм изменения настроек инстанса методом [SetSettings](https://green-api.com/docs/api/account/SetSettings/), который запускается при включении чатбота.

Все настройки по получению уведомлений выключены по умолчанию, чатбот включит следующие настройки:
```javascript
    let settings = await bot.telegram.restAPI.settings.setSettings({
        incomingWebhook: "yes",
        outgoingMessageWebhook: "yes",
        outgoingAPIMessageWebhook: "yes",
        pollMessageWebhook: "yes",
        markIncomingMessagesReaded: "yes"
    })
```
которые отвечают за получение уведомлений о входящих и исходящих сообщениях.

Процесс изменения настроек занимает несколько минут, в течении этого времени инстанс будет недоступен. Сообщения отправленные чатботу в это время не будут обработаны.

После того как будут применены настройки, произойдет удаление уведомлений о полученных ранее входящих сообщениях. Этот процесс так же прописан в библиотеке [whatsapp-chatbot-js](https://github.com/green-api/whatsapp-chatbot-js) и автоматически запускается после изменения настроек.

Это необходимо для того, чтобы чатбот не начал обрабатывать сообщения со старых чатов.

После того как изменения настроек и удаление входящих уведомлений будут исполнены, чатбот начнет стандартно отвечать на сообщения. Суммарно этот процесс занимает не больше 5 минут.

Чтобы остановить работу чатбота, используйте сочетание клавиш `Ctrl + C` в командной строке.

## Настройка чатбота

По умолчанию чатбот использует ссылки для выгрузки файлов из сети, однако пользователи могут добавить свои ссылки на файлы, одну для файла любого расширения pdf / docx /... и одну для картинки.

Ссылки должны вести на файлы из облачного хранилища или открытого доступа. В сцене `endpointsScene` есть следующий код для отправки файла:
```javascript
    endpointsScene.hears(['2'], (ctx) => {
        if (checkSession(ctx)) {
            ctx.telegram.restAPI.file.sendFileByUrl(
                ctx.update.message.chat.id.toString(),
                undefined,
                "https://storage.yandexcloud.net/sw-prod-03-test/ChatBot/corgi.pdf",
                "image.pdf",
                strings.send_file_message[ctx.session.lang] + strings.links[ctx.session.lang].send_file_documentation)
        }
    })
```
Добавьте ссылку на файл любого расширения в качестве первого параметра метода `answerWithUrlFile` и задайте имя файлу во втором параметре. Имя файла должно содержать расширение, например "somefile.pdf".
Данная строка после изменения будет в следующем формате:
```javascript
    endpointsScene.hears(['2'], (ctx) => {
        if (checkSession(ctx)) {
            ctx.telegram.restAPI.file.sendFileByUrl(
                ctx.update.message.chat.id.toString(),
                undefined,
                "https://...somefile.pdf",
                "somefile.pdf",
                strings.send_file_message[ctx.session.lang] + strings.links[ctx.session.lang].send_file_documentation)
        }
    })
```

Все изменения должны быть сохранены, после чего можно запускать чатбот. Для запуска чатбота вернитесь к [пункту 2](#запуск-чатбота).

## Использование

Если предыдущие шаги были выполнены, то на вашем аккаунте Whatsapp должен работать чатбот. Важно помнить, что пользователь должен быть авторизован в [личном кабинете](https://console.green-api.com/){:target="_blank"}.

Теперь вы можете отправлять сообщения чатботу!

Чатбот откликнется на любое сообщение отправленное на аккаунт.
Так как чатбот поддерживает несколько языков - то прежде чем поприветствовать собеседника, чатбот попросит выбрать язык общения:
```
1 - English
2 - Қазақша
3 - Русский
...
```
Ответьте цифрой 1, 2 или 3, чтобы выбрать язык для дальнейшего общения. После того как вы отправите 3, чатбот пришлет приветственное сообщение на русском языке:
```
Добро пожаловать в GREEN-API чатбот, пользователь! GREEN-API предоставляет отправку данных следующих видов. Выберите цифру из списка, чтобы проверить как работает метод отправки

1. Текстовое сообщение 📩
2. Файл 📋
3. Картинка 🖼
4. Аудио 🎵
5. Видео 📽
6. ...

Чтобы вернуться в начало напишите стоп или 0
```
Выбрав число из списка и отправив его, чатбот ответит каким API был отправлен данный тип сообщения и поделится ссылкой на информацию об API.

Например, отправив 1, пользователь получит в ответ:
```
Это сообщение отправлено через метод sendMessage.

Чтобы узнать как работает метод, пройдите по ссылке
https://green-api.com/docs/api/sending/SendMessage/
```
Если отправить что-то помимо чисел 1-13, то чатбот лаконично ответит:
```
Извините, я не совсем вас понял 😔, напишите меню, чтобы посмотреть возможные опции
```
Так же пользователь может вызвать меню, отправив сообщение содержащее "меню". И отправив "стоп", пользователь завершит беседу с чатботом и получит сообщение:
```
Спасибо за использование чатбота GREEN-API, пользователь!
```

## Структура кода

Основной файл чатбота это [`bot.js`](bot.js){:target="_blank"}, в нем находится функция `main` и с нее начинается выполнение программы. В этом файле происходит инициализация объекта бота, установка первой сцены и запуск бота.

```javascript
async function main() {
    const strings = getStringsData()  //Получения данных strings.yml файла, в котором хранятся реплики бота
    
    const bot = new WhatsAppBot({       //Инициация объекта бота
        idInstance: "{{INSTANCE_ID}}",
        apiTokenInstance: "{{TOKEN}}",
    })

    let settings = await bot.telegram.restAPI.settings.setSettings({    //Установка настроек, чтобы бот получал все нужные вебхуки
        incomingWebhook: "yes",
        outgoingMessageWebhook: "yes",
        outgoingAPIMessageWebhook: "yes",
        pollMessageWebhook: "yes",
        markIncomingMessagesReaded: "yes"
    })
    console.log(settings);

    await clearWebhookQueue(bot) //Очистка очереди вебхуков от старых уведомлений, чтобы бот не обрабатывал их
    
    //
    //...Описание сцен
    //
    
    const stage = new Stage([mainMenuScene, endpointsScene, startScene, createGroup]) //Регистрация сцен в состоянии бота
    
    bot.use(session())
    bot.use(stage.middleware())
    bot.on('message', (ctx) => ctx.scene.enter('startScene'))   //Установка первой сцены
    launchBotWithErrorHandler(bot)                              //Запуск бота
}
```

Данный бот использует сцены для организации кода. Это значит, что логика чатбота разделена на фрагменты (сцены), сцена соответствует определенному состоянию диалога и отвечает за обработку ответа.

Для каждого чата одновременно активна может быть только одна сцена.

Например, первая сцена `startScene` отвечает за приветственное сообщение. Вне зависимости от текста сообщения, бот спрашивает какой язык удобен пользователю и включает следующую сцену, которая отвечает за обработку ответа.

Всего в боте 4 сцены:

- Сцена `startScene` - отвечает на любое входящее сообщение, отправляет список доступных языков. Запускает сцену `MainMenu`.
- Сцена `mainMenuScene` - обрабатывает выбор пользователя и отправляет текст главного меню на выбранном языке. Запускает сцену `Endpoints`
- Сцена `endpointsScene` - выполняет выбранный пользователем метод и отправляет описание метода на выбранном языке.
- Сцена `createGroup` - создает группу, если пользователь сказал, что добавил бота в свои контакты. Если нет, возвращается к сцене «конечные точки».

Метод `checkSession` используется, чтобы снова устанавливать стартовую сцену, если боту не пишут более 2 минут. Он проверяет как давно было поселение касание пользователя и если оно было более 5 минут назад, обновляет сессию и начинает диалог заново.

Файл `ymlReader` содержит функцию, которая возвращает данные из файла `strings.xml`. Этот файл используется для хранения реплик бота.

## Управление сообщениями

Как и указывает чатбот в ответах, все сообщения отправлены через API. Документацию по методам отправки сообщений можно найти на сайте [green-api.com/docs/api/sending](https://green-api.com/docs/api/sending/).

Что касается получения сообщений, то сообщения вычитываются через HTTP API. Документацию по методам получения сообщений можно найти на сайте [green-api.com/docs/api/receiving/technology-http-api](https://green-api.com/docs/api/receiving/technology-http-api/).

Чатбот использует библиотеку [whatsapp-chatbot-js](https://github.com/green-api/whatsapp-chatbot-js){:target="_blank"}, где уже интегрированы методы отправки и получения сообщений, поэтому сообщения вычитываются автоматически, а отправка обычных текстовых сообщений упрощена.

Например, чатбот автоматически отправляет сообщение контакту, от которого получил сообщение:
```javascript
    ctx.reply("text")
```
Однако другие методы отправки можно вызвать напрямую из библиотеки [whatsapp-api-client-js](https://github.com/green-api/whatsapp-api-client-js){:target="_blank"}. Как, например, при получении аватара:
```javascript
    ctx.telegram.restAPI.instance.getAvatar(
        ctx.update.message.from.id.toString(),
        undefined);
```

## Лицензия

Лицензировано на условиях [Creative Commons Attribution-NoDerivatives 4.0 International (CC BY-ND 4.0)](https://creativecommons.org/licenses/by-nd/4.0/).

[LICENSE](https://github.com/green-api/whatsapp-demo-chatbot-js/blob/master/LICENCE).